<!DOCTYPE html>
<html>
<head>
<title>EBC Human Presence Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
margin:0;
font-family:Arial;
text-align:center;
background:radial-gradient(circle at top,#0f2027,#000);
color:#00f7ff;
}
button{
padding:12px 25px;
font-size:16px;
border-radius:6px;
border:none;
background:#00f7ff;
color:black;
cursor:pointer;
margin:10px;
}
canvas{
background:#111;
margin-top:15px;
touch-action:none;
border:1px solid #00f7ff;
}
#result{
font-size:22px;
margin-top:15px;
font-weight:bold;
}
</style>
</head>
<body>

<h2>EBC â€“ Human Presence Verification</h2>
<button onclick="startTest()">Run Verification</button>

<div id="result"></div>
<canvas id="drawArea" width="320" height="200"></canvas>

<script>
let rawData=[];
let collecting=false;
let sampleRate=0;
let tremorScore=0;

function startTest(){
rawData=[];
collecting=true;
tremorScore=0;
document.getElementById("result").innerText="Collecting Tremor...";
setTimeout(()=>{
collecting=false;
processSignal();
},5000);
}

window.addEventListener("devicemotion",function(e){
if(!collecting) return;
if(!e.acceleration) return;
let x=e.acceleration.x||0;
let y=e.acceleration.y||0;
let z=e.acceleration.z||0;
let mag=Math.sqrt(x*x+y*y+z*z);
rawData.push(mag);
});

function processSignal(){

if(rawData.length<30){
document.getElementById("result").innerText="Not enough data";
return;
}

sampleRate=rawData.length/5;

let mean=rawData.reduce((a,b)=>a+b,0)/rawData.length;
let variance=rawData.reduce((a,b)=>a+(b-mean)*(b-mean),0)/rawData.length;
let std=Math.sqrt(variance);

let diff=[];
for(let i=1;i<rawData.length;i++){
diff.push(rawData[i]-rawData[i-1]);
}

let fftResult=fft(diff);
let freqResolution=sampleRate/diff.length;

let bandEnergy=0;
let totalEnergy=0;

for(let i=0;i<fftResult.length;i++){
let freq=i*freqResolution;
totalEnergy+=fftResult[i];
if(freq>=8 && freq<=12){
bandEnergy+=fftResult[i];
}
}

// ðŸ”’ Gate condition
if(totalEnergy < 0.1 || std < 0.01){
tremorScore=0;
}else{
let ratio=bandEnergy/(totalEnergy+0.00001);
tremorScore=Math.min(100,ratio*600);
}

startChallenge();
}

function fft(signal){
let N=signal.length;
let result=[];
for(let k=0;k<N/2;k++){
let real=0,imag=0;
for(let n=0;n<N;n++){
let angle=2*Math.PI*k*n/N;
real+=signal[n]*Math.cos(angle);
imag-=signal[n]*Math.sin(angle);
}
result[k]=Math.sqrt(real*real+imag*imag)/N;
}
return result;
}

// ---------- Dynamic Challenge ----------

let canvas=document.getElementById("drawArea");
let ctx=canvas.getContext("2d");
let points=[];
let currentChallenge=0;

function startChallenge(){
points=[];
ctx.clearRect(0,0,320,200);
currentChallenge=Math.floor(Math.random()*4);
ctx.strokeStyle="#00f7ff";
ctx.lineWidth=3;
ctx.beginPath();

if(currentChallenge===0){ // horizontal
ctx.moveTo(20,100);
ctx.lineTo(300,100);
}
if(currentChallenge===1){ // vertical
ctx.moveTo(160,20);
ctx.lineTo(160,180);
}
if(currentChallenge===2){ // zigzag
ctx.moveTo(20,150);
ctx.lineTo(80,50);
ctx.lineTo(140,150);
ctx.lineTo(200,50);
ctx.lineTo(260,150);
}
if(currentChallenge===3){ // triangle
ctx.moveTo(80,150);
ctx.lineTo(160,50);
ctx.lineTo(240,150);
ctx.lineTo(80,150);
}

ctx.stroke();
}

canvas.addEventListener("touchmove",function(e){
e.preventDefault();
let rect=canvas.getBoundingClientRect();
let x=e.touches[0].clientX-rect.left;
let y=e.touches[0].clientY-rect.top;
points.push({x,y});
ctx.fillStyle="white";
ctx.fillRect(x,y,3,3);
});

canvas.addEventListener("touchend",function(){
evaluateChallenge();
});

function evaluateChallenge(){

let valid=0;

for(let p of points){
if(currentChallenge===0 && Math.abs(p.y-100)<20) valid++;
if(currentChallenge===1 && Math.abs(p.x-160)<20) valid++;
if(currentChallenge===2 && p.y<160 && p.y>40) valid++;
if(currentChallenge===3 && p.y<160 && p.y>40) valid++;
}

let accuracy=(valid/points.length)*100;

let finalScore=(tremorScore*0.6)+(accuracy*0.4);

if(finalScore>50){
document.getElementById("result").innerText=
"Human Verified\nTremor: "+tremorScore.toFixed(0)+"% | Challenge: "+accuracy.toFixed(0)+"%";
}else{
document.getElementById("result").innerText=
"Verification Failed\nTremor: "+tremorScore.toFixed(0)+"% | Challenge: "+accuracy.toFixed(0)+"%";
}

points=[];
}
</script>

</body>
</html>
