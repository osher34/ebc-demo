<!DOCTYPE html>
<html>
<head>
<title>EBC Advanced Tremor Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin:0;
    font-family:Arial;
    text-align:center;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color:white;
    padding-top:40px;
}
button {
    padding:15px 30px;
    font-size:18px;
    border-radius:8px;
    border:none;
    background:#00c6ff;
    cursor:pointer;
}
#result {
    font-size:28px;
    margin-top:25px;
    font-weight:bold;
}
canvas {
    margin-top:20px;
    background:#111;
}
</style>
</head>
<body>

<h2>EBC Advanced 8–12Hz Detection</h2>
<p>Hold phone steady for 5 seconds</p>
<button onclick="startTest()">Start Test</button>
<div id="result"></div>
<canvas id="graph" width="320" height="160"></canvas>

<script>
let rawData=[];
let collecting=false;
let sampleRate=0;

function startTest(){
    rawData=[];
    collecting=true;
    document.getElementById("result").innerText="Collecting...";
    requestPermission();
    setTimeout(()=>{
        collecting=false;
        processSignal();
    },5000);
}

function requestPermission(){
    if(typeof DeviceMotionEvent.requestPermission==='function'){
        DeviceMotionEvent.requestPermission().then(p=>{
            if(p==='granted'){
                window.addEventListener('devicemotion',handleMotion);
            }
        });
    } else {
        window.addEventListener('devicemotion',handleMotion);
    }
}

function handleMotion(e){
    if(!collecting) return;
    if(!e.acceleration) return;

    let x=e.acceleration.x||0;
    let y=e.acceleration.y||0;
    let z=e.acceleration.z||0;

    let mag=Math.sqrt(x*x+y*y+z*z);
    rawData.push(mag);
}

function processSignal(){
    if(rawData.length<20){
        document.getElementById("result").innerText="Not enough data";
        return;
    }

    sampleRate=rawData.length/5;

    // 1️⃣ Derivative
    let diff=[];
    for(let i=1;i<rawData.length;i++){
        diff.push(rawData[i]-rawData[i-1]);
    }

    // 2️⃣ Remove mean (high-pass basic)
    let mean=diff.reduce((a,b)=>a+b,0)/diff.length;
    diff=diff.map(v=>v-mean);

    // 3️⃣ Apply Hamming Window
    for(let i=0;i<diff.length;i++){
        let w=0.54-0.46*Math.cos((2*Math.PI*i)/(diff.length-1));
        diff[i]*=w;
    }

    // 4️⃣ FFT
    let fftResult=fft(diff);
    let freqResolution=sampleRate/diff.length;

    let bandEnergy=0;
    for(let i=0;i<fftResult.length;i++){
        let freq=i*freqResolution;
        if(freq>=8 && freq<=12){
            bandEnergy+=fftResult[i];
        }
    }

    // 5️⃣ Smart normalization
    let totalEnergy=fftResult.reduce((a,b)=>a+b,0);
    let ratio=bandEnergy/(totalEnergy+0.0001);

    let score=Math.min(100,ratio*800);

    drawGraph(fftResult,freqResolution);

    if(score>10){
        document.getElementById("result").style.color="#00ff99";
        document.getElementById("result").innerText="Biological Activity Detected\nScore: "+score.toFixed(0)+"%";
    } else {
        document.getElementById("result").style.color="#ff4d4d";
        document.getElementById("result").innerText="Low Biological Signal\nScore: "+score.toFixed(0)+"%";
    }
}

function fft(signal){
    let N=signal.length;
    let result=[];
    for(let k=0;k<N/2;k++){
        let real=0,imag=0;
        for(let n=0;n<N;n++){
            let angle=2*Math.PI*k*n/N;
            real+=signal[n]*Math.cos(angle);
            imag-=signal[n]*Math.sin(angle);
        }
        result[k]=Math.sqrt(real*real+imag*imag)/N;
    }
    return result;
}

function drawGraph(data,res){
    let canvas=document.getElementById("graph");
    let ctx=canvas.getContext("2d");
    ctx.clearRect(0,0,320,160);
    ctx.strokeStyle="#00c6ff";
    ctx.beginPath();

    for(let i=0;i<data.length;i++){
        let freq=i*res;
        if(freq>20) break;

        let x=i*5;
        let y=160-data[i]*200;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    }
    ctx.stroke();
}
</script>

</body>
</html>
