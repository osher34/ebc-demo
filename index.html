<!DOCTYPE html>
<html>
<head>
<title>EBC Tremor Frequency Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin: 0;
    font-family: Arial;
    text-align: center;
    background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color: white;
    padding-top: 40px;
}
button {
    padding: 15px 30px;
    font-size: 18px;
    border-radius: 8px;
    border: none;
    background: #00c6ff;
    cursor: pointer;
}
#result {
    font-size: 28px;
    margin-top: 25px;
    font-weight: bold;
}
canvas {
    margin-top: 20px;
    background: #111;
}
</style>
</head>
<body>

<h2>EBC 8â€“12Hz Tremor Detection</h2>
<p>Hold your phone steady for 5 seconds</p>
<button onclick="startTest()">Start Test</button>
<div id="result"></div>
<canvas id="graph" width="300" height="150"></canvas>

<script>
let data = [];
let collecting = false;
let startTime;
let sampleRate = 0;

function startTest(){
    data = [];
    collecting = true;
    document.getElementById("result").innerText = "Collecting...";
    requestPermission();
    startTime = Date.now();
    setTimeout(()=>{
        collecting = false;
        analyze();
    },5000);
}

function requestPermission(){
    if(typeof DeviceMotionEvent.requestPermission === 'function'){
        DeviceMotionEvent.requestPermission().then(permissionState=>{
            if(permissionState==='granted'){
                window.addEventListener('devicemotion', handleMotion);
            }
        }).catch(console.error);
    } else {
        window.addEventListener('devicemotion', handleMotion);
    }
}

function handleMotion(event){
    if(!collecting) return;

    let acc = event.acceleration;
    if(!acc) return;

    let magnitude = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
    data.push(magnitude);
}

function analyze(){
    if(data.length < 10){
        document.getElementById("result").innerText="Not enough data";
        return;
    }

    sampleRate = data.length / 5;

    let fftResult = fft(data);
    let freqResolution = sampleRate / data.length;

    let bandEnergy = 0;

    for(let i=0;i<fftResult.length;i++){
        let freq = i * freqResolution;
        if(freq >=8 && freq <=12){
            bandEnergy += fftResult[i];
        }
    }

    let score = Math.min(100, bandEnergy * 10);

    drawGraph(fftResult, freqResolution);

    if(score > 5){
        document.getElementById("result").style.color="#00ff99";
        document.getElementById("result").innerText="Biological Tremor Detected\nScore: "+score.toFixed(0)+"%";
    } else {
        document.getElementById("result").style.color="#ff4d4d";
        document.getElementById("result").innerText="Low Tremor Activity\nScore: "+score.toFixed(0)+"%";
    }
}

function fft(signal){
    let N = signal.length;
    let result = [];
    for(let k=0;k<N/2;k++){
        let real=0, imag=0;
        for(let n=0;n<N;n++){
            let angle = 2*Math.PI*k*n/N;
            real += signal[n]*Math.cos(angle);
            imag -= signal[n]*Math.sin(angle);
        }
        result[k] = Math.sqrt(real*real+imag*imag)/N;
    }
    return result;
}

function drawGraph(fftData, resolution){
    let canvas=document.getElementById("graph");
    let ctx=canvas.getContext("2d");
    ctx.clearRect(0,0,300,150);

    ctx.strokeStyle="#00c6ff";
    ctx.beginPath();

    for(let i=0;i<fftData.length;i++){
        let freq=i*resolution;
        if(freq>20) break;

        let x=i*5;
        let y=150 - fftData[i]*100;

        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    }
    ctx.stroke();
}
</script>

</body>
</html>
