<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EBC Live Verification</title>
<style>

body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,#0a0f1f,#111a33);
color:white;
text-align:center;
}

.card{
width:95%;
max-width:420px;
margin:15px auto;
padding:15px;
background:rgba(255,255,255,0.05);
border-radius:20px;
box-shadow:0 0 25px rgba(0,255,255,0.2);
}

h2{color:#00eaff;margin:5px;}

button{
padding:10px 20px;
border:none;
border-radius:10px;
background:#00eaff;
color:black;
font-weight:bold;
cursor:pointer;
}

canvas{
margin-top:10px;
background:#0c1326;
border-radius:12px;
}

#xyz{
margin-top:8px;
font-size:14px;
}

#result{
margin-top:10px;
font-size:16px;
}

.star{
color:gold;
font-size:20px;
}

.progress{
height:6px;
background:#222;
margin-top:10px;
border-radius:4px;
overflow:hidden;
}

.progressBar{
height:100%;
width:0%;
background:yellow; /* שינינו לצהוב */
}

</style>
</head>
<body>

<div class="card">
<h2>EBC – Human Presence</h2>
<button onclick="startTest()">Run Verification</button>

<div class="progress">
<div id="bar" class="progressBar"></div>
</div>

<canvas id="challengeCanvas" width="320" height="120"></canvas>

<canvas id="graphX" width="320" height="60"></canvas>
<canvas id="graphY" width="320" height="60"></canvas>
<canvas id="graphZ" width="320" height="60"></canvas>

<div id="xyz">X:0 | Y:0 | Z:0</div>
<div id="result"></div>
</div>

<script>

let collecting=false;
let tremorValues=[];
let xArr=[],yArr=[],zArr=[];
let duration=5000;
let challengeType=0;
let points=[];

function startTest(){
tremorValues=[];
xArr=[];yArr=[];zArr=[];
points=[];
collecting=true;
document.getElementById("result").innerHTML="";
animateBar();
drawChallenge();

setTimeout(()=>{
collecting=false;
analyze();
},duration);
}

function animateBar(){
let start=Date.now();
let interval=setInterval(()=>{
let p=(Date.now()-start)/duration*100;
document.getElementById("bar").style.width=p+"%";
if(p>=100) clearInterval(interval);
},50);
}

window.addEventListener("devicemotion",function(e){
if(!collecting || !e.acceleration) return;

let x=e.acceleration.x||0;
let y=e.acceleration.y||0;
let z=e.acceleration.z||0;

/* DEAD ZONE FILTER */
if(Math.abs(x)<0.02) x=0;
if(Math.abs(y)<0.02) y=0;
if(Math.abs(z)<0.02) z=0;

xArr.push(x);
yArr.push(y);
zArr.push(z);

let mag=Math.sqrt(x*x+y*y+z*z);
tremorValues.push(mag);

drawGraphs();
document.getElementById("xyz").innerHTML=
"X:"+x.toFixed(2)+" | Y:"+y.toFixed(2)+" | Z:"+z.toFixed(2);
});

function analyze(){
if(tremorValues.length<10){
document.getElementById("result").innerHTML="No Data";
return;
}

let mean=tremorValues.reduce((a,b)=>a+b)/tremorValues.length;
let variance=tremorValues.reduce((a,b)=>a+(b-mean)*(b-mean),0)/tremorValues.length;
let std=Math.sqrt(variance);

let tremorScore=std<0.015?0:Math.min(100,std*1800);

let challengeScore=points.length>15?100:0;

if(tremorScore===0){
document.getElementById("result").innerHTML=
"❌ Not Human<br>"+
"Tremor: 0%<br>"+
"Challenge: "+challengeScore+"%";
return;
}

let stars=Math.round((tremorScore+challengeScore)/200*3);
let starDisplay="";
for(let i=0;i<stars;i++) starDisplay+="★";

document.getElementById("result").innerHTML=
"✅ Human Verified<br>"+
"Tremor: "+tremorScore.toFixed(0)+"%<br>"+
"Challenge: "+challengeScore+"%<br>"+
"<span class='star'>"+starDisplay+"</span>";
}

function drawGraphs(){
drawLine("graphX",xArr,"red");
drawLine("graphY",yArr,"lime");
drawLine("graphZ",zArr,"cyan");
}

function drawLine(id,data,color){
let c=document.getElementById(id);
let ctx=c.getContext("2d");
ctx.clearRect(0,0,c.width,c.height);
ctx.strokeStyle=color;
ctx.beginPath();
for(let i=0;i<data.length;i++){
let x=i;
let y=30-data[i]*10;
if(i===0) ctx.moveTo(x,y);
else ctx.lineTo(x,y);
}
ctx.stroke();
}

/* ---------- CHALLENGE ---------- */

let challengeCanvas=document.getElementById("challengeCanvas");
let cctx=challengeCanvas.getContext("2d");

function drawChallenge(){
cctx.clearRect(0,0,320,120);
challengeType=Math.floor(Math.random()*3);
cctx.strokeStyle="#00eaff";
cctx.lineWidth=3;
cctx.beginPath();

if(challengeType===0){
cctx.moveTo(20,60); cctx.lineTo(300,60);
}
if(challengeType===1){
cctx.moveTo(60,20); cctx.lineTo(60,100);
}
if(challengeType===2){
cctx.arc(160,60,40,0,2*Math.PI);
}

cctx.stroke();
}

challengeCanvas.addEventListener("touchmove",function(e){
let rect=challengeCanvas.getBoundingClientRect();
let x=e.touches[0].clientX-rect.left;
let y=e.touches[0].clientY-rect.top;
points.push({x,y});
cctx.fillStyle="white";
cctx.fillRect(x,y,3,3);
});

</script>
</body>
</html>
